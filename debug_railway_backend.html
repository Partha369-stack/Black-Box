<!DOCTYPE html>
<html>
<head>
    <title>Debug Railway Backend</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>üîç Debug Railway Backend QR Generation</h1>
    
    <div class="test-section">
        <h2>1. Check Railway Razorpay Credentials</h2>
        <button onclick="checkCredentials()">Check Credentials</button>
        <div id="credentialsLog" class="log"></div>
    </div>

    <div class="test-section">
        <h2>2. Test Order Creation (Detailed)</h2>
        <button onclick="testOrderCreation()">Create Test Order</button>
        <div id="orderLog" class="log"></div>
    </div>

    <div class="test-section">
        <h2>3. Check Railway Environment</h2>
        <button onclick="checkEnvironment()">Check Environment</button>
        <div id="envLog" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info', elementId = 'orderLog') {
            const logs = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            logs.innerHTML += `<span class="${className}">${timestamp}: ${message}</span>\n`;
            console.log(message);
        }

        async function checkCredentials() {
            log('üîç Checking Railway Razorpay credentials...', 'info', 'credentialsLog');

            try {
                const response = await fetch('https://black-box-production.up.railway.app/api/debug/razorpay');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`üìä Railway Credentials Status:`, 'info', 'credentialsLog');
                    log(`üîë Key ID Set: ${data.razorpay_key_id_set ? '‚úÖ' : '‚ùå'}`, data.razorpay_key_id_set ? 'success' : 'error', 'credentialsLog');
                    log(`üîë Key ID: ${data.razorpay_key_id_value}`, 'info', 'credentialsLog');
                    log(`üîê Secret Set: ${data.razorpay_secret_set ? '‚úÖ' : '‚ùå'}`, data.razorpay_secret_set ? 'success' : 'error', 'credentialsLog');
                    log(`üîê Secret: ${data.razorpay_secret_value}`, 'info', 'credentialsLog');
                    log(`üåç Environment: ${data.environment}`, 'info', 'credentialsLog');

                    if (data.razorpay_key_id_set && data.razorpay_secret_set) {
                        log('‚úÖ Railway Razorpay credentials are properly configured!', 'success', 'credentialsLog');
                    } else {
                        log('‚ùå Railway Razorpay credentials are MISSING!', 'error', 'credentialsLog');
                        log('üí° You need to set RAZORPAY_KEY_ID and RAZORPAY_KEY_SECRET on Railway', 'warning', 'credentialsLog');
                    }
                } else {
                    log(`‚ùå Failed to check credentials: ${response.status}`, 'error', 'credentialsLog');
                    const errorText = await response.text();
                    log(`Error details: ${errorText}`, 'error', 'credentialsLog');
                }

            } catch (error) {
                log(`‚ùå Error checking Railway credentials: ${error.message}`, 'error', 'credentialsLog');
            }
        }

        async function checkEnvironment() {
            log('üåç Checking Railway environment...', 'info', 'envLog');

            try {
                const response = await fetch('https://black-box-production.up.railway.app/api/health');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Railway backend is running`, 'success', 'envLog');
                    log(`üìä Status: ${data.status}`, 'info', 'envLog');
                    log(`üïê Timestamp: ${data.timestamp}`, 'info', 'envLog');
                } else {
                    log(`‚ùå Railway backend health check failed: ${response.status}`, 'error', 'envLog');
                }

            } catch (error) {
                log(`‚ùå Error checking Railway environment: ${error.message}`, 'error', 'envLog');
            }
        }

        async function testOrderCreation() {
            log('üß™ Testing detailed order creation on Railway...', 'info');
            
            const testOrder = {
                items: [
                    { id: '1', name: 'Test Product', price: 10, quantity: 1 }
                ],
                totalAmount: 10,
                customerName: 'Debug Test',
                customerPhone: '9999999999'
            };
            
            try {
                log('üì§ Sending order to Railway backend...', 'info');
                log(`üì¶ Order data: ${JSON.stringify(testOrder, null, 2)}`, 'info');
                
                const response = await fetch('https://black-box-production.up.railway.app/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Tenant-ID': 'VM-001'
                    },
                    body: JSON.stringify(testOrder)
                });
                
                log(`üì• Response status: ${response.status}`, 'info');
                log(`üì• Response headers: ${JSON.stringify([...response.headers.entries()], null, 2)}`, 'info');
                
                const responseText = await response.text();
                log(`üì• Raw response: ${responseText}`, 'info');
                
                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        log(`‚úÖ Order creation response:`, 'success');
                        log(`üÜî Order ID: ${data.orderId}`, 'info');
                        log(`üéØ QR Code URL: ${data.qrCodeUrl}`, 'info');
                        log(`üîó QR Code ID: ${data.qrCodeId}`, 'info');
                        log(`üí≥ Razorpay Order ID: ${data.razorpayOrderId}`, 'info');
                        log(`‚úÖ Success: ${data.success}`, 'info');
                        log(`üìù Message: ${data.message}`, 'info');
                        
                        // Analyze QR code URL
                        if (data.qrCodeUrl) {
                            if (data.qrCodeUrl.includes('rzp.io') || data.qrCodeUrl.includes('razorpay')) {
                                log('‚úÖ REAL RAZORPAY QR CODE DETECTED!', 'success');
                            } else if (data.qrCodeUrl.includes('qrserver.com')) {
                                log('‚ùå PLACEHOLDER QR CODE DETECTED!', 'error');
                                log('üîç This means Razorpay QR generation failed on Railway', 'warning');
                            } else {
                                log('‚ùì UNKNOWN QR CODE TYPE', 'warning');
                            }
                        } else {
                            log('‚ùå NO QR CODE URL IN RESPONSE', 'error');
                        }
                        
                    } catch (parseError) {
                        log(`‚ùå Failed to parse response JSON: ${parseError.message}`, 'error');
                    }
                } else {
                    log(`‚ùå Order creation failed with status ${response.status}`, 'error');
                    log(`üìù Error response: ${responseText}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Network error: ${error.message}`, 'error');
            }
        }

        // Auto-run checks on page load
        window.onload = function() {
            log('üöÄ Page loaded, running automatic checks...', 'info', 'credentialsLog');
            setTimeout(() => {
                checkCredentials();
                setTimeout(() => {
                    checkEnvironment();
                }, 1000);
            }, 500);
        };
    </script>
</body>
</html>
